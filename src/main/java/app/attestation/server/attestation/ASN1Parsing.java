/* Copyright 2019, The Android Open Source Project, Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package app.attestation.server.attestation;

import org.bouncycastle.asn1.ASN1Boolean;
import org.bouncycastle.asn1.ASN1Encodable;
import org.bouncycastle.asn1.ASN1Enumerated;
import org.bouncycastle.asn1.ASN1Integer;

/** Utils to get java representation of ASN1 types. */
class ASN1Parsing {

  private ASN1Parsing() {}

  static boolean getBooleanFromAsn1(ASN1Encodable asn1Value) {
    // AttestationServer-change START [1/2]: Provide a strict-by-default parsing of ASN1Encodable for boolean.
    return getBooleanFromAsn1(asn1Value, true);
  }

  static boolean getBooleanFromAsn1(ASN1Encodable asn1Value, boolean strict) {
    // AttestationServer-change END [1/2]: Provide a strict-by-default parsing of ASN1Encodable for boolean.
    if (asn1Value instanceof ASN1Boolean) {
      // AttestationServer-change START [2/2]: Provide a strict-by-default parsing of ASN1Encodable for boolean.
      if (strict) {
        return Utils.getBooleanFromAsn1Strict((ASN1Boolean) asn1Value);
      }
      // AttestationServer-change END [2/2]: Provide a strict-by-default parsing of ASN1Encodable for boolean.
      return ((ASN1Boolean) asn1Value).isTrue();
    } else {
      throw new IllegalArgumentException(
          "Boolean value expected; found " + asn1Value.getClass().getName() + " instead.");
    }
  }

  static int getIntegerFromAsn1(ASN1Encodable asn1Value) {
    // AttestationServer-change START [1/3]: Provide a strict-by-default parsing of ASN1Encodable for integer.
    return getIntegerFromAsn1(asn1Value, true);
    // AttestationServer-change END [1/3]: Provide a strict-by-default parsing of ASN1Encodable for integer.
  }

  static int getIntegerFromAsn1(ASN1Encodable asn1Value, boolean strict) {
    if (asn1Value instanceof ASN1Integer) {
      // AttestationServer-change START [2/3]: Provide a strict-by-default parsing of ASN1Encodable for integer.
      if (strict) {
        return Utils.intValueFromBigIntegerStrict(((ASN1Integer) asn1Value).getValue());
      }
      // AttestationServer-change END [2/3]: Provide a strict-by-default parsing of ASN1Encodable for integer.
      return ((ASN1Integer) asn1Value).getValue().intValueExact();
    } else if (asn1Value instanceof ASN1Enumerated) {
      // AttestationServer-change START [3/3]: Provide a strict-by-default parsing of ASN1Encodable for integer.
      if (strict) {
        return Utils.intValueFromBigIntegerStrict(((ASN1Enumerated) asn1Value).getValue());
      }
      // AttestationServer-change END [3/3]: Provide a strict-by-default parsing of ASN1Encodable for integer.
      return ((ASN1Enumerated) asn1Value).getValue().intValueExact();
    } else {
      throw new IllegalArgumentException(
          "Integer value expected; found " + asn1Value.getClass().getName() + " instead.");
    }
  }
}
